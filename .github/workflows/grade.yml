name: Autograde - 2.1 HTML Basics

on:
  push:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  # === Assignment deadline in UTC ===
  # Local deadline: 2025-09-04 20:59 AST (UTC+3)
  # Converted to UTC: 2025-09-04T17:59:00Z
  DEADLINE_UTC: "2025-09-04T17:59:00Z"

  # Submission points policy (on-time → 25, any late → 0)
  MAX_SUBMISSION_POINTS: "25"
  MIN_SUBMISSION_POINTS: "0"
  LATE_DEDUCT_PER_DAY: "25"  # full deduction for any lateness

  # HTML file students should submit
  HTML_FILE: "index.html"

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute submission-time points
        id: submission_time
        shell: bash
        run: |
          set -euo pipefail
          echo "Deadline (UTC):  ${DEADLINE_UTC}"
          latest_ts="$(git log -1 --format=%cI)"
          echo "Latest commit:   ${latest_ts}"

          dl_epoch=$(date -u -d "${DEADLINE_UTC}" +%s)
          sub_epoch=$(date -u -d "${latest_ts}" +%s)

          max_pts=${MAX_SUBMISSION_POINTS}
          min_pts=${MIN_SUBMISSION_POINTS}
          per_day=${LATE_DEDUCT_PER_DAY}

          if [ "${sub_epoch}" -le "${dl_epoch}" ]; then
            pts="${max_pts}"
            echo "On-time submission → ${pts} points"
          else
            pts=$(( max_pts - per_day ))
            if [ "${pts}" -lt "${min_pts}" ]; then
              pts="${min_pts}"
            fi
            echo "Late submission → ${pts} points"
          fi

          echo "points=${pts}" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (use ci if lockfile exists)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f package-lock.json ]]; then
            echo "package-lock.json found → using npm ci"
            npm ci
          else
            echo "No lockfile → using npm install"
            npm install --no-audit --no-fund
          fi

      - name: Run autograder
        run: npm run grade
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          HTML_FILE: ${{ env.HTML_FILE }}
          SUBMISSION_POINTS: ${{ steps.submission_time.outputs.points }}

      - name: Upload artifacts (CSV/JSON/MD)
        uses: actions/upload-artifact@v4
        with:
          name: grading-artifacts
          path: |
            GRADE.md
            grade_report.json
            grade_report.csv

      - name: Create or update grading issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const title = 'Automated Grade: 2.1 HTML Basics';
            const body = fs.readFileSync('GRADE.md', 'utf8');
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['grading','autograde']
              });
            }
